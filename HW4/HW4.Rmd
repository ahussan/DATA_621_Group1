---
title: "DATA 621 Homework 4"
author: "Critical Thinking Group 1"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
  pdf_document:
    toc: yes
    toc_depth: 4
  html_document:
    toc: yes
    toc_depth: '2'
    smart: no
  word_document:
    toc: yes
    toc_depth: '2'
---
\pagebreak
\begin{center}
\bigskip
\bigskip
\bigskip
Prepared for:\\
\medskip
Prof. Dr. Nasrin Khansari\\
\smallskip
City University of New York, School of Professional Studies - Data 621\\
\bigskip
DATA 621 – Business Analytics and Data Mining\\
\medskip
Home Work 3\\
\medskip
Prepared by:\\
\medskip
Critical Thinking Group  1\\ 
\medskip
Vic Chan\\ 
\smallskip
Gehad Gad\\
\smallskip
Evan McLaughlin\\  
\smallskip
Bruno de Melo\\
\smallskip
Anjal Hussan\\
\smallskip
Zhouxin Shi\\
\smallskip
Sie Siong Wong\\
\end{center}

\pagebreak


```{r message=FALSE, warning=FALSE, echo=FALSE}
if (!require('ggplot2')) (install.packages('ggplot2'))
if(!require('dplyr')) (install.packages('dplyr'))
if(!require('tidyr')) (install.packages('tidyr'))
if(!require('purrr')) (install.packages('purrr'))
if(!require('mice')) (install.packages('mice'))
if(!require('DataExplorer')) (install.packages('DataExplorer'))
if(!require('MASS')) (install.packages('MASS'))
if(!require('caret')) (install.packages('caret'))
if(!require('stats')) (install.packages('stats'))
if(!require('randomForest')) (install.packages('randomForest'))
library(DataExplorer)

```


\newpage

# Overview

In this homework assignment, we will explore, analyze and model a data set containing approximately 8000 records representing a customer at an auto insurance company. Each record has two response variables. The first response variable, TARGET_FLAG, is a 1 or a 0. A “1” means that the person was in a car crash. A zero means that the person was not in a car crash. The second response variable is TARGET_AMT. This value is zero if the person did not crash their car. But if they did crash their car, this number will be a value greater than zero.


# Statement of the Problem

The purpose of this report is to build multiple linear regression and binary logistic regression models on the training data to predict the probability that a person will crash their car and also the amount of money it will cost if the person does crash their car. 

# Data Exploration  

```{r echo=FALSE}

Train_Data <- read.csv("https://raw.githubusercontent.com/ahussan/DATA_621_Group1/main/HW4/insurance_training_data.csv")
Eval_Data <- read.csv("https://raw.githubusercontent.com/ahussan/DATA_621_Group1/main/HW4/insurance-evaluation-data.csv")
```


Let's take a look in the structure of our train data set - excluding the first column **index** which it is not to be used.


```{r echo=FALSE}
Train_Data <- Train_Data[,-1]
str(Train_Data)
```
We can see that the training data has 8161 observations(rows) and 25 variables (columns). Of these 25 columns, many are of factors type but were imported as characters or doubles - there will be properly converted in the preparation section. Also, there may be some ordinal levels within some of the factors. 

Below we display a summary of each feature.


```{r echo=FALSE}
#Summary of each feature

summary(Train_Data) 
```

We can observe the followings:

**KIDSDRIV**: Max is 4

**AGE**: age is 16 is the youngest and oldest 81. There are 6 NA values

**HOMEKIDS**: Max is 5

**TRAVTIME**: 75% of the population is below 44 but the Max value is 142. It looks like there may be some outliers here. 

**TIF**: The majority of people are not long time customers

**CLM_FREQ**: Maximum is over 5 years

**MVR_PTS**: 75% have 3 or less, maximum is 13

**CAR_AGE**: Strange!. The minimum -3 and Max is 28. There are 510 NA values. These negative values will have to be excluded from the analysis.

**INCOME** - **BLUEBOOK** - **HOME_VAL** - **OLDCLAIM** : These are numerical variables that need to be converted accordingly.


##Convertion to numerical

As can be seen below, these four features are now corrected represented.

```{r echo=FALSE}
Train_Data$INCOME <- gsub(",","",(Train_Data$INCOME))
Train_Data$INCOME <- sub('.', '', Train_Data$INCOME)
Train_Data$INCOME <-trimws(Train_Data$INCOME, which = c("both"), whitespace = "[ \t\r\n]")
Train_Data$INCOME <- as.numeric(Train_Data$INCOME)

Train_Data$HOME_VAL <- gsub(",","",(Train_Data$HOME_VAL))
Train_Data$HOME_VAL <- sub('.', '', Train_Data$HOME_VAL)
Train_Data$HOME_VAL <-trimws(Train_Data$HOME_VAL, which = c("both"), whitespace = "[ \t\r\n]")
Train_Data$HOME_VAL <- as.numeric(Train_Data$HOME_VAL)
# 
Train_Data$BLUEBOOK <- gsub(",","",(Train_Data$BLUEBOOK))
Train_Data$BLUEBOOK <- sub('.', '', Train_Data$BLUEBOOK)
Train_Data$BLUEBOOK <-trimws(Train_Data$BLUEBOOK, which = c("both"), whitespace = "[ \t\r\n]")
Train_Data$BLUEBOOK <- as.numeric(Train_Data$BLUEBOOK)
# 
Train_Data$OLDCLAIM <- gsub(",","",(Train_Data$OLDCLAIM))
Train_Data$OLDCLAIM <- sub('.', '', Train_Data$OLDCLAIM)
Train_Data$OLDCLAIM <-trimws(Train_Data$OLDCLAIM, which = c("both"), whitespace = "[ \t\r\n]")
Train_Data$OLDCLAIM <- as.numeric(Train_Data$OLDCLAIM)
# 
summary(Train_Data[,c(7,9,16,20)])
```

##Missing Values

```{r echo=FALSE}
#missing values by column
colSums(is.na(Train_Data)) 
```

There are missing values in several variables for a total of 1,879 NA's or about 1% of the total dataset.

##Univariate Distribution - Histograms

Below the numeric feature distributions are displayed.

```{r message=FALSE, warning=FALSE, echo=FALSE}
Train_Data1<-select_if(Train_Data, is.numeric)
Train_Data1 %>%
  keep(is.numeric) %>%                     
  gather() %>%                            
  ggplot(aes(value)) +                     
    facet_wrap(~ key, scales = "free") +  
    geom_density()  

```
We can see that AGE, BLUEBOOK, CAR_AGE, HOME_VAL, INCOME, TRAVTIME and YOJ resemblance somewhat a normal distribution while CLM_FREQ, HOMEKIDS, KIDSDRIV, MVR_PTS, OLDCLAIM, TARGET_AMT, TIF resemblance either a binomial or Poisson distribution.

Some of the variables present a lot of zeros which could be explained as lack of data, and as such should be excluded, for example in HOMEVAL, while in others they are a rightful part of the distribution, and should be considered in the analysis, such as in INCOME, CLM_FREQ, HOMEKIDS, KIDSDRV, MVR_PTS,  OLDCLAIM, etc.


For the categorical features, we will displayed their distribution using bar charts.


```{r message=FALSE, warning=FALSE, echo=FALSE}
Train_Data %>% select(!is.numeric) %>%
  gather() %>%                            
  ggplot(aes(value)) +                     
    facet_wrap(~ key, scales = "free") +  
   geom_bar() + coord_flip()  
```

### Correlation matrix

```{r, echo=FALSE}
plot_correlation(Train_Data)
```
```{r, echo=FALSE}
pairs(Train_Data1 %>% select_if(is.numeric))
```
# 2. DATA PREPARATION

## Adjusting Variables  
Looking at the plots we see we have to make a few changes to some variables. We'll make HOMEKIDS boolean instead of a factor. For the rows where CAR_AGE are labled numbers, we make 0. For blank JOBS we label those as "Unknown". Finally, change Education to 1 if PhD and Masters.
```{r Homekids}
Train_Data$HOMEKIDS[Train_Data$HOMEKIDS != 0 ] <- 1
Eval_Data$HOMEKIDS[Eval_Data$HOMEKIDS != 0 ] <- 1
```

```{r CarAge}
Train_Data$CAR_AGE[Train_Data$CAR_AGE < 0 ] <- 0
Eval_Data$CAR_AGE[Eval_Data$CAR_AGE < 0 ] <- 0
```

```{r JOB}
Train_Data$JOB <- as.character(Train_Data$JOB)
Train_Data$JOB[Train_Data$JOB == ""] <- "Unknown"
Train_Data$JOB <- as.factor(Train_Data$JOB)
Eval_Data$JOB <- as.character(Eval_Data$JOB)
Eval_Data$JOB[Eval_Data$JOB == ""] <- "Unknown"
Eval_Data$JOB <- as.factor(Eval_Data$JOB)
```

```{r Education}
Train_Data$EDUCATION <- ifelse(Train_Data$EDUCATION %in% c("PhD", "Masters"), 0, 1)
```

## Missing Data  
We have missing data in income, yoj, home_val, and car_age. 
```{r}
summary(Train_Data)
plot_missing(Train_Data)
```

```{r}
m_train <- median(Train_Data$AGE, na.rm = T)
Train_Data$AGE[is.na(Train_Data$AGE)] <- m_train
m_test <- median(Train_Data$AGE, na.rm = T)
Train_Data$AGE[is.na(Train_Data$AGE)] <- m_test

impute_train_data <- mice(Train_Data, m=5, maxit=20, method='pmm', seed=321)
complete_train_data <- complete(impute_train_data,2)
```

## Building Models

### Model #1
Our first model will seek to create a baseline using binary response variable, using a logistic regression model that contains all of our features. 
```{r}
Binary1 <- glm(TARGET_FLAG~., family=binomial, data=Cut_Train)
summary(Binary1)
```
The AIC result from the binomial model can be derived using the logit link function. 

### Model #2
This model will be derived using a stepwise approach to determine which is more significant. We also attempt to identify impacts from multicollinearity.

```{r}
Binary_step <- step(Binary1)
summary(Binary_step)
```
Judging by AIC, the stepwise approach reduces the dimensionality and improves fit, given its lower estimated prediction error. This suggests that, in addition to being a simple model, the stepwise method works better to create an overall better fit to the data.  

### Model #3
Another method for binary modeling includes a random forest model that uses the same set of variables from the previous two models.

```{r}
RF <- randomForest::randomForest(TARGET_FLAG~., data=Train_Data)
```

We next ran some multivariate regression models, using the features to predict the numeric response variable, TARGET_AMT, which gives the costs associated with a car's accident, creating a multiple linear regression model to predict the response variable.

### Model #4 - All Variables

For the multi linear regression we want to know what is going to be the insurance cost if a person has crashed their car. We are going to build a multi linear regression model which includes all the data, from there we will keep the variables that have significance and use that to build subsequence models. We will first need to create a dataset specifically for a multi linear regression as we only care about if a customer has crashed their car. 

```{r}
mlr_data = complete_train_data %>%
  filter(TARGET_FLAG == 1) %>%
  dplyr::select(-1)
```

```{r}
mlr1 = lm(TARGET_AMT ~ ., data = mlr_data)
summary(mlr1)
```

```{r}
par(mfrow=c(2,2))
plot(mlr1)
```

Looking at the plot above we can see that the Residual vs Fitted graph has a large variance for a couple of outliers while a majority of the points have very low residuals. Also looking at the Normal Q-Q graph we can see that it is not a normal distribution. This is quite good for a model which utilizes all of the variables and we would like to see if we can improve the model by selecting variables that are significant.

Some variables that we would like to use for the next model are **KIDSDRIV**, **SEX**, **CAR_USE**, **REVOKED**, and **CAR_AGE**. These variables makes a lot of are usually thought of as the variables which can increase the cost of insurance

### Model #5 - Hand Picking Variables

```{r}
mlr2 = lm(TARGET_AMT ~ KIDSDRIV + SEX + CAR_USE + REVOKED + CAR_AGE, data=mlr_data)
summary(mlr2)
```

```{r}
par(mfrow=c(2,2))
plot(mlr2)
```

With the second model we can see that we have a lower R Squared value in our new model compared to the first model which included all the variables. We can also see that there is still a large variance with the Residual vs Fitted plot. We will next try to use a stepwise function to find the best model from all the variables.

### Model #6 - Stepwise Function

```{r}
mlr3 = stepAIC(mlr1, direction='backward', trace=FALSE)
summary(mlr3)
```

```{r}
par(mfrow=c(2,2))
plot(mlr3)
```

Using the backward step function we can see that the model choose **MSTATUS**, **SEX**, **BLUEBOOK**, **REVOKED**, and **MVR_PTS**. Looking at the residual vs fitted plot we still see a variance caused by outliers.

# Model Selection

## Multi Linear Regression
We will be looking at all the models created and looking at the metrics like R Squared Value, RMSE, F-Statistics, and Residual Plots in order to determine which is the best model which represents our data. We will then compare the best model selected against the evaluation data set in order to see if the model truly represents the dataset

```{r}
m1.summary = summary(MV1)
m2.summary = summary(MV2_step)
```